# 第三章、服务器性能剖析

**说明：本章内容理论及方法介绍较多，详细信息建议查看原书。**

最常遇到的三个性能相关的问题是：如何确认服务器是否达到了性能最佳的状态、找出某条语句为什么执行不够快，以及诊断被用户描述成“停顿”或者“卡死”的某些间歇性疑难故障。

## 性能优化简介

我们将性能定义为完成某件任务所需的时间度量，换句话说，性能即响应时间。数据库服务器的性能用查询的响应时间来度量，单位是每个查询花费的时间。

### 通过性能剖析进行优化

性能剖析是测量和分析时间花费在哪里的主要方法。性能剖析一般有两个步骤：测量任务所花费的时间；然后对结果进行统计和排序，将重要的任务排到前面。

### 理解性能剖析

Mysql的性能剖析将最重要的任务展现在前面，但有时候没显示出来的信息也很重要。尽管性能剖析输出了排名、总计和平均值，但还是有很多需要的信息是缺失的，例如：值得优化的查询、异常情况、被掩盖的细节等。

## 剖析Mysql查询

### 剖析服务器负载

剖析并找出代价高的查询可以使用慢查询日志。

#### 捕获Mysql的查询到日志文件中

在Mysql中，慢查询日志最初只是捕获比较慢的查询，而性能剖析却需要针对所有的查询。而且在Mysql 5.0及之前的版本中，慢查询日志的响应时间的单位是秒，粒度太粗了。在Mysql5.2及更新的版本中，慢查询的功能以及被加强，可以通过设置`long_query_time`为0来捕获所有的查询，而且查询的响应时间单位已经可以做到微秒级。

在Mysql的当前版本中，慢查询日志是开销最低、精度最高的测量查询时间的工具。不必担心开启慢查询日志会带来额外的I/O开销，经测试慢查询日志带来的开销可以忽略不计。更需要担心的是日志可能消耗大量的磁盘空间。如果长期开启慢查询日志，注意要部署日志轮转工具。或者不要长期启用慢查询日志，只在需要收集负载样本的期间开启即可。

Mysql还有另外一种查询日志，称之为“通用日志”，但很少用于分析和剖析服务器性能。通用日志在查询请求道服务器时进行记录，所以不包含响应时间和执行计划等重要信息。

Percona Server的慢查询日志比Mysql官方版本记录了更多细节且有价值的信息，如查询执行计划、锁、I/O活动等。另外在可管理性上也进行了增强，比如全局修改针对每个连接的`long_query_time`的阈值。

总的来说，慢查询日志是一种轻量而且功能全面的性能剖析工具，是优化服务器查询的利器。

#### 分析查询日志

不要直接打开整个慢查询日志进行分析，首先应该生成一个剖析报告。从慢查询日志中生成剖析报告需要一款好工具，这里建议使用`pt-query-digest`。该工具功能强大，包括可以将查询报告保存到数据库中，以及追踪工作负载随时间的变化。

### 剖析单条查询

#### 使用SHOW PROFILE

`SHOW PROFIEL`命令时在Mysql 5.1以后的版本中引入的，默认是禁用的，但可以通过服务器变量在连接级别动态的修改。

```sql
mysql> SET profiling = 1;
```
然后在服务器上执行的所有语句，都会测量其耗费的时间和其他一些查询执行状态变更相关的数据。

#### 使用SHOW STATUS

Mysql的`SHOW STATUS`命令返回了一些计数器。既有服务器级别的全局计数器，也有基于某个连接的会话级别的计数器。

#### 使用慢查询日志

#### 使用Performance Schema

## 诊断间歇性问题

### 单条查询问题还是服务器问题

如果发现了问题，首先要确认这是单条查询的问题，还是服务器的问题。

#### 使用SHOW GLABEL STATUS

以较高的频率比如一秒执行一次`SHOW GLOBAL STATUS`命令捕获数据，问题出现时，则可以通过某些计数器(比如Threads_running、Threads_connected、Questions和Queries)的“凸出”或“凹陷”来发现。

#### 使用SHOW PROCESSLIST

通过不停地捕获`SHOW PROCESSLIST`的输出，来观察是否有大量线程处于不正常的状态或者有其他不正常的特征。

使用`SHOW PROCESSLIST`命令时，在尾部加上`\G`可以垂直的方式输出结果，这很有用，因为这样会将每一行记录的每一列都单独输出为一行，这样可以方便地使用`sort|uniq|sort`一类的命令来计算某个列值出现的次数：

![](https://github.com/maoyunfei/static-sources/blob/master/mysql_1.png?raw=true)

如果Mysql服务器的版本较新，也可以直接查询`INFORMATION_SCHEMA`中的`PROCESSLIST`表；或者使用`innotop`工具以较高的频率刷新，以观察屏幕出现的不正常查询堆积。

#### 使用慢查询日志

### 捕获诊断数据

当出现间歇性问题时，需要尽可能多地收集所有数据，而不只是问题出现时的数据。

#### 诊断触发器

#### 需要收集什么样的数据

#### 解释结果数据


